!function(){"use strict";class t{constructor(){this.boardSize=8,this.container=null,this.boardEl=null,this.cells=[],this.cellClickListeners=[],this.cellEnterListeners=[],this.cellLeaveListeners=[],this.newGameListeners=[],this.saveGameListeners=[],this.loadGameListeners=[]}bindToDOM(t){if(!(t instanceof HTMLElement))throw new Error("container is not HTMLElement");this.container=t}drawUi(t){this.checkBinding(),this.container.innerHTML='\n      <div class="controls">\n        <button data-id="action-restart" class="btn">New Game</button>\n        <button data-id="action-save" class="btn">Save Game</button>\n        <button data-id="action-load" class="btn">Load Game</button>\n      </div>\n      <div class="board-container">\n        <div data-id="board" class="board"></div>\n      </div>\n    ',this.newGameEl=this.container.querySelector("[data-id=action-restart]"),this.saveGameEl=this.container.querySelector("[data-id=action-save]"),this.loadGameEl=this.container.querySelector("[data-id=action-load]"),this.newGameEl.addEventListener("click",(t=>this.onNewGameClick(t))),this.saveGameEl.addEventListener("click",(t=>this.onSaveGameClick(t))),this.loadGameEl.addEventListener("click",(t=>this.onLoadGameClick(t))),this.boardEl=this.container.querySelector("[data-id=board]"),this.boardEl.classList.add(t);for(let t=0;t<this.boardSize**2;t+=1){const a=document.createElement("div");a.classList.add("cell","map-tile","map-tile-"+(e=t,s=this.boardSize,0===e?"top-left":e>0&&e<s-1?"top":e===s-1?"top-right":e===s*(s-1)?"bottom-left":e%s==0?"left":e>s*(s-1)&&e<s**2-1?"bottom":e===s**2-1?"bottom-right":(e+1)%s==0?"right":"center")),a.addEventListener("mouseenter",(t=>this.onCellEnter(t))),a.addEventListener("mouseleave",(t=>this.onCellLeave(t))),a.addEventListener("click",(t=>this.onCellClick(t))),this.boardEl.appendChild(a)}var e,s;this.cells=Array.from(this.boardEl.children)}redrawPositions(t){for(const t of this.cells)t.innerHTML="";for(const s of t){const t=this.boardEl.children[s.position],a=document.createElement("div");a.classList.add("character",s.character.type);const i=document.createElement("div");i.classList.add("health-level");const r=document.createElement("div");r.classList.add("health-level-indicator","health-level-indicator-"+((e=s.character.health)<15?"critical":e<50?"normal":"high")),r.style.width=`${s.character.health}%`,i.appendChild(r),a.appendChild(i),t.appendChild(a)}var e}addCellEnterListener(t){this.cellEnterListeners.push(t)}addCellLeaveListener(t){this.cellLeaveListeners.push(t)}addCellClickListener(t){this.cellClickListeners.push(t)}addNewGameListener(t){this.newGameListeners.push(t)}addSaveGameListener(t){this.saveGameListeners.push(t)}addLoadGameListener(t){this.loadGameListeners.push(t)}onCellEnter(t){t.preventDefault();const e=this.cells.indexOf(t.currentTarget);this.cellEnterListeners.forEach((t=>t.call(null,e)))}onCellLeave(t){t.preventDefault();const e=this.cells.indexOf(t.currentTarget);this.cellLeaveListeners.forEach((t=>t.call(null,e)))}onCellClick(t){const e=this.cells.indexOf(t.currentTarget);this.cellClickListeners.forEach((t=>t.call(null,e)))}onNewGameClick(t){t.preventDefault(),this.newGameListeners.forEach((t=>t.call(null)))}onSaveGameClick(t){t.preventDefault(),this.saveGameListeners.forEach((t=>t.call(null)))}onLoadGameClick(t){t.preventDefault(),this.loadGameListeners.forEach((t=>t.call(null)))}static showError(t){alert(t)}static showMessage(t){alert(t)}selectCell(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"yellow";this.deselectCell(t),this.cells[t].classList.add("selected",`selected-${e}`)}deselectCell(t){const e=this.cells[t];e.classList.remove(...Array.from(e.classList).filter((t=>t.startsWith("selected"))))}showCellTooltip(t,e){this.cells[e].title=t}hideCellTooltip(t){this.cells[t].title=""}showDamage(t,e){return new Promise((s=>{const a=this.cells[t],i=document.createElement("span");i.textContent=e,i.classList.add("damage"),a.appendChild(i),i.addEventListener("animationend",(()=>{a.removeChild(i),s()}))}))}setCursor(t){this.boardEl.style.cursor=t}checkBinding(){if(null===this.container)throw new Error("GamePlay not bind to DOM")}}var e={1:"prairie",2:"desert",3:"arctic",4:"mountain"};class s{constructor(){this.level=1,this.allCell=[],this.player=!0,this.selectedCell=null,this.selectedCharacter=""}static from(t){return null}}class a{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"generic";if(this.level=t,this.attack=0,this.defence=0,this.health=100,this.type=e,"Character"===new.target.name)throw new Error("Такого персонажа не существует")}}class i extends a{constructor(t,e){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"bowman";super(t,e),this.attack=25,this.defence=25,this.type=s}}class r extends a{constructor(t,e){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"swordsman";super(t,e),this.attack=40,this.defence=10,this.type=s}}class l extends a{constructor(t,e){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"magician";super(t,e),this.attack=10,this.defence=40,this.type=s}}class o extends a{constructor(t,e){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"vampire";super(t,e),this.attack=25,this.defence=25,this.type=s}}class h extends a{constructor(t,e){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"undead";super(t,e),this.attack=40,this.defence=10,this.type=s}}class n extends a{constructor(t,e){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"daemon";super(t,e),this.attack=10,this.defence=10,this.type=s}}function*c(t,e){const s=Math.floor(Math.random()*t.length),a=Math.floor(Math.random()*e)+1;yield new t[s](a)}function d(t,e,s){const a=[],i=s;for(let s=0;s<i;s+=1){const s=c(t,e);a.push(s.next().value)}return a}class m{constructor(t,e){if(!(t instanceof a))throw new Error("character must be instance of Character or its children");if("number"!=typeof e)throw new Error("position must be a number");this.character=t,this.position=e}}var p="auto",u="pointer",C="crosshair",f="not-allowed";const g=new t;g.bindToDOM(document.querySelector("#game-container"));const P=new class{constructor(t){this.storage=t}save(t){this.storage.setItem("state",JSON.stringify(t))}load(){try{return JSON.parse(this.storage.getItem("state"))}catch(t){throw new Error("Invalid state")}}}(localStorage),v=new class{constructor(t,e){this.gamePlay=t,this.stateService=e,this.gameState=new s,this.hero=[i,r,l],this.computer=[o,h,n],this.startPositionHero=[],this.startPositionComputer=[],this.heroTeam=[],this.computerTeam=[],this.startPosition=[],this.seceltedCell=null,this.selectCharacter=[],this.selectCharacterPosition=[],this.selectComputerPosition=[],this.selectCharacterComputer=[]}init(){this.gamePlay.drawUi(e[this.gameState.level]),this.startNewGame(),this.gamePlay.addCellEnterListener(this.onCellEnter.bind(this)),this.gamePlay.addCellClickListener(this.onCellClick.bind(this)),this.gamePlay.addCellLeaveListener(this.onCellLeave.bind(this)),this.gamePlay.addNewGameListener(this.startNewGame.bind(this)),this.gamePlay.addSaveGameListener(this.save.bind(this)),this.gamePlay.addLoadGameListener(this.load.bind(this))}positionUser(t){const e=this.gamePlay.boardSize,s=[];if(t===this.heroTeam){for(let t=0;t<=e*(e-1);t+=e)s.push(t),s.push(t+1);return s}for(let t=0;t<=e*(e-1);t+=e)s.push(t+(e-1)),s.push(t+(e-2));return s}startPositionGenerate(t,e){const s=[];for(let a=0;a<t.length;a+=1){let i=e[Math.floor(Math.random()*e.length)];for(;s.includes(i);)i=e[Math.floor(Math.random()*e.length)];this.startPosition.push(new m(t[a],i))}}selectedCharactar(t,e){for(let s=0;s<t.length;s+=1)if(t[s].position===e){const a=t[s];"bowman"!==a.character.type&&"swordsman"!==a.character.type&&"magician"!==a.character.type||(null!==this.seceltedCell&&this.gamePlay.deselectCell(this.seceltedCell),this.gamePlay.selectCell(a.position,"yellow"),this.seceltedCell=e,this.selectCharacter=a.character,this.selectCharacterPosition=a.position,this.gameState.player=!0)}}playAttack(t,e){const s=[],a=[],i=[];let r;for(let s=e%8-t;s<=e%8+t;s+=1)s>=0&&s<8&&a.push(s);for(let s=Math.floor(e/8)-t;s<=Math.floor(e/8)+t;s+=1)s>=0&&s<8&&i.push(s);for(let l=-t;l<t+1;l+=1)for(let o=-t;o<t+1;o+=1)r=e+8*l+o,r!==e&&!s.includes(r)&&r>=0&&r<64&&a.indexOf(r%8)>=0&&i.indexOf(Math.floor(r/8))>=0&&s.push(r);return s}positionAttack(t,e){let s=[];return"swordsman"!==t.type&&"undead"!==t.type||(s=this.playAttack(1,e)),"bowman"!==t.type&&"vampire"!==t.type||(s=this.playAttack(2,e)),"magician"!==t.type&&"daemon"!==t.type||(s=this.playAttack(4,e)),s}playMove(t,e,s){const a=s.map((t=>t.position)),i=[],r=[],l=[];let o=0;for(let s=e%8-t;s<=e%8+t;s+=1)s>=0&&s<8&&r.push(s);for(let s=Math.floor(e/8)-t;s<=Math.floor(e/8)+t;s+=1)s>=0&&s<8&&l.push(s);for(let s=-t;s<t+1;s+=1)for(let h=-t;h<t+1;h+=1){o=e+8*s+h;const t=Math.floor(o/8)===Math.floor(e/8)+s;o!==e&&!a.includes(o)&&t&&o>=0&&o<64&&r.indexOf(o%8)>=0&&l.indexOf(Math.floor(o/8))>=0&&i.push(o)}return i}positionMove(t,e){let s=[];return"swordsman"!==t.type&&"undead"!==t.type||(s=this.playMove(4,e,this.startPosition)),"bowman"!==t.type&&"vampire"!==t.type||(s=this.playMove(2,e,this.startPosition)),"magician"!==t.type&&"daemon"!==t.type||(s=this.playMove(1,e,this.startPosition)),s}computerAttack(){if(!1===this.gameState.player){const t=this.positionMove(this.selectCharacterComputer,this.selectComputerPosition),e=this.positionAttack(this.selectCharacterComputer,this.selectComputerPosition),s=Math.floor(Math.random()*t.length);if(this.seceltedCell!==s){for(let t=0;t<this.startPosition.length;t+=1)this.selectComputerPosition===this.startPosition[t].position&&(this.startPosition[t].position=s);if(this.gamePlay.redrawPositions(this.startPosition),e.indexOf(this.seceltedCell)>=0){const t=Math.floor(Math.max(.2*(this.selectCharacterComputer.attack-this.selectCharacter.defence),.1*this.selectCharacterComputer.attack));this.gamePlay.redrawPositions(this.startPosition),this.selectCharacter.health-=t,this.gamePlay.showDamage(this.selectCharacterPosition,t)}}this.gameState.player=!0}}levelUp(){for(let t=0;t<this.startPosition.length;t+=1){const e=this.startPosition[t].character;e.level+=1,e.attack=Math.floor(Math.max(e.attack,e.attack*(80+e.health)/100)),e.health+80<=100?e.health+=80:e.health=100,e.defence=Math.floor(Math.max(e.defence,e.defence*(80+e.health)/100)),this.heroTeam=e,this.startPosition[t].character=e}}startLevel(){this.computerTeam=d(this.computer,1,1),this.startPositionHero=this.positionUser(this.startPositionHero),this.startPositionGenerate(this.computerTeam,this.startPositionComputer),this.gamePlay.redrawPositions(this.startPosition)}clear(){this.startPosition=[],this.seceltedCell=null,this.selectCharacter=[],this.selectCharacterPosition=[],this.selectComputerPosition=[],this.selectCharacterComputer=[]}startNewGame(){this.clear(),this.heroTeam=d(this.hero,1,1),this.computerTeam=d(this.computer,1,1),this.startPositionHero=this.positionUser(this.heroTeam),this.startPositionComputer=this.positionUser(this.computerTeam),this.startPositionGenerate(this.heroTeam,this.startPositionHero),this.startPositionGenerate(this.computerTeam,this.startPositionComputer),this.gamePlay.redrawPositions(this.startPosition)}save(){const e={};e.player=this.gameState.player,e.level=this.gameState.level,e.selectedCell=this.seceltedCell,e.selectedCharacter=this.selectCharacter,e.startPosition=this.startPosition,this.stateService.save(e),t.showMessage("Игра сохранена")}createCharacter(t,e){return"bowman"===e?new i(t,"bowman"):"swordsman"===e?new r(t,"swordsman"):"magician"===e?new l(t,"magician"):"undead"===e?new h(t,"undead"):"vampire"===e?new o(t,"vampire"):"daemon"===e&&new n(t,"daemon")}load(){try{const s=this.stateService.load();this.gameState.player=s.player,this.gameState.level=s.level,this.gameState.selectedCell=s.selectedCell,this.gameState.selectedCharacter=s.selectedCharacter,this.gameState.selectedCell&&this.gamePlay.selectCell(this.gameState.selectedCell,"yellow"),this.gameState.selectedCharacter=s.selectedCharacter,this.startPosition=[],s.startPosition.forEach((t=>{const e=this.createCharacter(t.character.level,t.character.type);e.attack=t.character.attack,e.defence=t.character.defence,e.health=t.character.health;const s=new m(e,t.position);this.startPosition.push(s)})),this.gamePlay.drawUi(e[this.gameState.level]),this.gamePlay.redrawPositions(this.startPosition),t.showMessage("Игра загружена")}catch(e){t.showError("Нет сохранённой игры")}}characterInformation(t){return`🎖${t.level} ⚔${t.attack} 🛡${t.defence}  ❤${t.health}`}onCellClick(s){if(!0===this.gameState.player&&(this.selectedCharactar(this.startPosition,s),null!==this.selectCharacter)){const a=this.positionAttack(this.selectCharacter,this.seceltedCell);if(this.positionMove(this.selectCharacter,this.seceltedCell).includes(s)&&null!==this.selectCharacter){this.gamePlay.selectCell(s,"green");for(let t=0;t<this.startPosition.length;t+=1)this.selectCharacterPosition===this.startPosition[t].position&&(this.startPosition[t].position=s),this.selectComputerPosition=this.startPosition[t].position,this.selectCharacterComputer=this.startPosition[t].character;this.gamePlay.redrawPositions(this.startPosition),this.selectedCharactar(this.startPosition,s),this.gameState.player=!1,this.computerAttack(),this.selectCharacter.health<1&&(this.startPosition.splice(this.selectCharacter,1),this.gamePlay.redrawPositions(this.startPosition),this.gamePlay.deselectCell(s),this.gamePlay.setCursor(p))}else if(a.indexOf(s)>=0){const a=Math.floor(Math.max(.2*(this.selectCharacter.attack-this.selectCharacterComputer.defence),.1*this.selectCharacter.attack));if(this.selectCharacterComputer.health-=a,this.selectCharacterComputer.health<1){this.startPosition=this.startPosition.filter((t=>t.position!==s));for(const t of this.computerTeam)this.computerTeam.splice(t,1)}if(this.gamePlay.redrawPositions(this.startPosition),0===this.computerTeam.length){if(4===this.gameState.level)return void t.showMessage("Вы выиграли");this.gameState.level+=1,this.gamePlay.drawUi(e[this.gameState.level]),this.levelUp(),this.startLevel()}this.gamePlay.showDamage(s,a)}}}onCellEnter(t){const e=this.positionAttack(this.selectCharacter,this.seceltedCell);for(let s=0;s<this.startPosition.length;s+=1){const a=this.startPosition[s];if(a.position===t){this.gamePlay.setCursor(u);const s=this.characterInformation(a.character);this.gamePlay.showCellTooltip(s,t),"undead"!==a.character.type&&"vampire"!==a.character.type&&"daemon"!==a.character.type||a.position!==t||(e.indexOf(t)>=0?(this.gamePlay.setCursor(C),this.gamePlay.selectCell(t,"red")):this.gamePlay.setCursor(f))}}this.positionMove(this.selectCharacter,this.seceltedCell).includes(t)&&null!==this.seceltedCell&&this.gamePlay.selectCell(t,"green")}onCellLeave(t){t===this.seceltedCell&&null!==this.seceltedCell||this.gamePlay.deselectCell(t)}}(g,P);v.init()}();