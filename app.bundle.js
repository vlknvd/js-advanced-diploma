!function(){"use strict";class t{constructor(){this.boardSize=8,this.container=null,this.boardEl=null,this.cells=[],this.cellClickListeners=[],this.cellEnterListeners=[],this.cellLeaveListeners=[],this.newGameListeners=[],this.saveGameListeners=[],this.loadGameListeners=[]}bindToDOM(t){if(!(t instanceof HTMLElement))throw new Error("container is not HTMLElement");this.container=t}drawUi(t){this.checkBinding(),this.container.innerHTML='\n      <div class="controls">\n        <button data-id="action-restart" class="btn">New Game</button>\n        <button data-id="action-save" class="btn">Save Game</button>\n        <button data-id="action-load" class="btn">Load Game</button>\n      </div>\n      <div class="board-container">\n        <div data-id="board" class="board"></div>\n      </div>\n    ',this.newGameEl=this.container.querySelector("[data-id=action-restart]"),this.saveGameEl=this.container.querySelector("[data-id=action-save]"),this.loadGameEl=this.container.querySelector("[data-id=action-load]"),this.newGameEl.addEventListener("click",(t=>this.onNewGameClick(t))),this.saveGameEl.addEventListener("click",(t=>this.onSaveGameClick(t))),this.loadGameEl.addEventListener("click",(t=>this.onLoadGameClick(t))),this.boardEl=this.container.querySelector("[data-id=board]"),this.boardEl.classList.add(t);for(let t=0;t<this.boardSize**2;t+=1){const s=document.createElement("div");s.classList.add("cell","map-tile","map-tile-"+(e=t,a=this.boardSize,0===e?"top-left":e>0&&e<a-1?"top":e===a-1?"top-right":e===a*(a-1)?"bottom-left":e%a==0?"left":e>a*(a-1)&&e<a**2-1?"bottom":e===a**2-1?"bottom-right":(e+1)%a==0?"right":"center")),s.addEventListener("mouseenter",(t=>this.onCellEnter(t))),s.addEventListener("mouseleave",(t=>this.onCellLeave(t))),s.addEventListener("click",(t=>this.onCellClick(t))),this.boardEl.appendChild(s)}var e,a;this.cells=Array.from(this.boardEl.children)}redrawPositions(t){for(const t of this.cells)t.innerHTML="";for(const a of t){const t=this.boardEl.children[a.position],s=document.createElement("div");s.classList.add("character",a.character.type);const i=document.createElement("div");i.classList.add("health-level");const r=document.createElement("div");r.classList.add("health-level-indicator","health-level-indicator-"+((e=a.character.health)<15?"critical":e<50?"normal":"high")),r.style.width=`${a.character.health}%`,i.appendChild(r),s.appendChild(i),t.appendChild(s)}var e}addCellEnterListener(t){this.cellEnterListeners.push(t)}addCellLeaveListener(t){this.cellLeaveListeners.push(t)}addCellClickListener(t){this.cellClickListeners.push(t)}addNewGameListener(t){this.newGameListeners.push(t)}addSaveGameListener(t){this.saveGameListeners.push(t)}addLoadGameListener(t){this.loadGameListeners.push(t)}onCellEnter(t){t.preventDefault();const e=this.cells.indexOf(t.currentTarget);this.cellEnterListeners.forEach((t=>t.call(null,e)))}onCellLeave(t){t.preventDefault();const e=this.cells.indexOf(t.currentTarget);this.cellLeaveListeners.forEach((t=>t.call(null,e)))}onCellClick(t){const e=this.cells.indexOf(t.currentTarget);this.cellClickListeners.forEach((t=>t.call(null,e)))}onNewGameClick(t){t.preventDefault(),this.newGameListeners.forEach((t=>t.call(null)))}onSaveGameClick(t){t.preventDefault(),this.saveGameListeners.forEach((t=>t.call(null)))}onLoadGameClick(t){t.preventDefault(),this.loadGameListeners.forEach((t=>t.call(null)))}static showError(t){alert(t)}static showMessage(t){alert(t)}selectCell(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"yellow";this.deselectCell(t),this.cells[t].classList.add("selected",`selected-${e}`)}deselectCell(t){const e=this.cells[t];e.classList.remove(...Array.from(e.classList).filter((t=>t.startsWith("selected"))))}showCellTooltip(t,e){this.cells[e].title=t}hideCellTooltip(t){this.cells[t].title=""}showDamage(t,e){return new Promise((a=>{const s=this.cells[t],i=document.createElement("span");i.textContent=e,i.classList.add("damage"),s.appendChild(i),i.addEventListener("animationend",(()=>{s.removeChild(i),a()}))}))}setCursor(t){this.boardEl.style.cursor=t}checkBinding(){if(null===this.container)throw new Error("GamePlay not bind to DOM")}}var e={1:"prairie",2:"desert",3:"arctic",4:"mountain"};class a{constructor(){this.level=1,this.allCell=[],this.player=!0,this.selectedCell=null,this.selectedCharacter=""}}class s{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"generic";if(this.level=t,this.attack=0,this.defence=0,this.health=100,this.type=e,"Character"===new.target.name)throw new Error("Такого персонажа не существует")}}class i extends s{constructor(t,e){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"bowman";super(t,e),this.attack=25,this.defence=25,this.type=a}}class r extends s{constructor(t,e){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"swordsman";super(t,e),this.attack=40,this.defence=10,this.type=a}}class l extends s{constructor(t,e){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"magician";super(t,e),this.attack=10,this.defence=40,this.type=a}}class o extends s{constructor(t,e){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"vampire";super(t,e),this.attack=25,this.defence=25,this.type=a}}class h extends s{constructor(t,e){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"undead";super(t,e),this.attack=40,this.defence=10,this.type=a}}class n extends s{constructor(t,e){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"daemon";super(t,e),this.attack=10,this.defence=10,this.type=a}}function*c(t,e){const a=Math.floor(Math.random()*t.length),s=Math.floor(Math.random()*e)+1;yield new t[a](s)}function d(t,e,a){const s=[],i=a;for(let a=0;a<i;a+=1){const a=c(t,e);s.push(a.next().value)}return s}class m{constructor(t,e){if(!(t instanceof s))throw new Error("character must be instance of Character or its children");if("number"!=typeof e)throw new Error("position must be a number");this.character=t,this.position=e}}var p="pointer",u="crosshair",f="not-allowed";const y=new t;y.bindToDOM(document.querySelector("#game-container"));const g=new class{constructor(t){this.storage=t}save(t){this.storage.setItem("state",JSON.stringify(t))}load(){try{return JSON.parse(this.storage.getItem("state"))}catch(t){throw new Error("Invalid state")}}}(localStorage),C=new class{constructor(t,e){this.gamePlay=t,this.stateService=e,this.gameState=new a,this.hero=[i,r,l],this.computer=[o,h,n],this.startPositionHero=[],this.startPositionComputer=[],this.heroTeam=[],this.computerTeam=[],this.startPosition=[],this.seceltedCell=null,this.selectCharacter=[],this.selectCharacterPosition=[],this.selectComputerPosition=[],this.selectCharacterComputer=[]}init(){this.startNewGame(),this.gamePlay.addCellEnterListener(this.onCellEnter.bind(this)),this.gamePlay.addCellClickListener(this.onCellClick.bind(this)),this.gamePlay.addCellLeaveListener(this.onCellLeave.bind(this)),this.gamePlay.addNewGameListener(this.startNewGame.bind(this)),this.gamePlay.addSaveGameListener(this.save.bind(this)),this.gamePlay.addLoadGameListener(this.load.bind(this))}startNewGame(){this.clear(),this.startLevel()}startLevel(){this.gamePlay.drawUi(e[this.gameState.level]),this.generateTeam(this.hero),this.generateTeam(this.computer),this.startPositionGenerate(this.heroTeam),this.startPositionGenerate(this.computerTeam),this.gamePlay.redrawPositions(this.startPosition)}generateTeam(t){if(t===this.hero){const t=this.startPosition.map((t=>t));this.heroTeam=[];for(const e of t)"bowman"!==e.character.type&&"swordsman"!==e.character.type&&"magician"!==e.character.type||(this.heroTeam.push(e.character),this.startPosition.shift());const e=this.gameState.level+1-this.heroTeam.length;if(e){const t=d(this.hero,1,e);this.heroTeam=this.heroTeam.concat(...t)}}if(t===this.computer){const t=this.startPosition.map((t=>t));this.computerTeam=[];for(const e of t)"undead"!==e.character.type&&"vampire"!==e.character.type&&"daemon"!==e.character.type||(this.computerTeam.push(e.character),this.startPosition.shift());const e=this.gameState.level+1-this.computerTeam.length;if(e){const t=d(this.computer,1,e);this.computerTeam=this.computerTeam.concat(t)}}}positionUser(t,e){let a=0;const s=this.gamePlay.boardSize,i=[];for(const e of t)a="bowman"===e.type||"swordsman"===e.type||"magician"===e.type?0:6;for(let t=0;t<s;t+=1)e.includes(t*s+a)||i.push(t*s+a),e.includes(t*s+a+1)||i.push(t*s+a+1);return i[Math.floor(Math.random()*i.length)]}startPositionGenerate(t){const e=[];for(const a of t){const s=this.positionUser(t,e);e.push(s),this.startPosition.push(new m(a,s))}}selectedCharactar(t,e){for(let a=0;a<t.length;a+=1)if(t[a].position===e){const s=t[a];"bowman"!==s.character.type&&"swordsman"!==s.character.type&&"magician"!==s.character.type||(null!==this.seceltedCell&&this.gamePlay.deselectCell(this.seceltedCell),this.gamePlay.selectCell(e,"yellow"),this.seceltedCell=e,this.selectCharacter=s.character,this.gameState.player=!0)}}playAttack(t,e){const a=[],s=[],i=[];let r;for(let a=e%8-t;a<=e%8+t;a+=1)a>=0&&a<8&&s.push(a);for(let a=Math.floor(e/8)-t;a<=Math.floor(e/8)+t;a+=1)a>=0&&a<8&&i.push(a);for(let l=-t;l<t+1;l+=1)for(let o=-t;o<t+1;o+=1)r=e+8*l+o,r!==e&&!a.includes(r)&&r>=0&&r<64&&s.indexOf(r%8)>=0&&i.indexOf(Math.floor(r/8))>=0&&a.push(r);return a}positionAttack(t,e){let a=[];return"swordsman"!==t.type&&"undead"!==t.type||(a=this.playAttack(1,e)),"bowman"!==t.type&&"vampire"!==t.type||(a=this.playAttack(2,e)),"magician"!==t.type&&"daemon"!==t.type||(a=this.playAttack(4,e)),a}playMove(t,e,a){const s=a.map((t=>t.position)),i=[],r=[],l=[];let o=0;for(let a=e%8-t;a<=e%8+t;a+=1)a>=0&&a<8&&r.push(a);for(let a=Math.floor(e/8)-t;a<=Math.floor(e/8)+t;a+=1)a>=0&&a<8&&l.push(a);for(let a=-t;a<t+1;a+=1){const h=0===a?t:Math.abs(a),n=0===a?1:Math.abs(a);for(let t=-h;t<h+1;t+=n)o=e+8*a+t,o!==e&&!s.includes(o)&&Math.floor(o/8)===Math.floor(e/8)+a&&o>=0&&o<64&&r.indexOf(o%8)>=0&&l.indexOf(Math.floor(o/8))>=0&&i.push(o)}return i}positionMove(t,e){let a=[];return"swordsman"!==t.type&&"undead"!==t.type||(a=this.playMove(4,e,this.startPosition)),"bowman"!==t.type&&"vampire"!==t.type||(a=this.playMove(2,e,this.startPosition)),"magician"!==t.type&&"daemon"!==t.type||(a=this.playMove(1,e,this.startPosition)),a}computerAttack(){const t=[],e=[],a={damage:0};for(const s of this.startPosition){"bowman"!==s.character.type&&"swordsman"!==s.character.type&&"magician"!==s.character.type||t.push(s),"undead"!==s.character.type&&"vampire"!==s.character.type&&"daemon"!==s.character.type||e.push(s);for(const s of e){const e=s.character,i=s.position,r=this.positionAttack(s.character,s.position);for(const s of t)if(r.indexOf(s.position)>=0){const t=s.character;let r=Math.max(.2*(e.attack-t.defence),.1*e.attack);r=Math.floor(r),r>a.damage&&(a.damage=r,a.attackerPosition=i,a.defenderPosition=s.position)}}}if(a.damage>0){const t=this.startPosition.find((t=>t.position===a.defenderPosition));return t.character.health-=a.damage,t.character.health<1&&(this.seceltedCell=null,this.selectedCharacter="",this.gamePlay.deselectCell(t.position),this.startPosition=this.startPosition.filter((e=>e.position!==t.position))),this.gamePlay.showDamage(t.position,a.damage).then((()=>setTimeout((()=>{this.gamePlay.redrawPositions(this.startPosition),0===this.teamSize(this.heroTeam)&&(this.gameState.player=!1,this.seceltedCell=null,this.selectedCharacter="")}),10))),void(this.gameState.player=!0)}let s=Math.floor(Math.random()*e.length);const i=e[s],r=this.positionMove(i.character,i.position);s=Math.floor(Math.random()*r.length),i.position=r[s],this.gamePlay.redrawPositions(this.startPosition),this.gameState.player=!0}levelUp(){for(const t of this.startPosition){const e=t.character;e.level+=1,e.attack=Math.floor(Math.max(e.attack,e.attack*(80+e.health)/100)),e.defence=Math.floor(Math.max(e.defence,e.defence*(80+e.health)/100)),e.health+80<=100?e.health+=80:e.health=100,t.character=e}}clear(){this.startPosition=[],this.seceltedCell=null,this.selectCharacter=[],this.gameState.level=1,this.gameState.player=!0}save(){const e={};e.player=this.gameState.player,e.level=this.gameState.level,e.selectedCell=this.seceltedCell,e.selectedCharacter=this.selectCharacter,e.startPosition=this.startPosition,this.stateService.save(e),t.showMessage("Игра сохранена")}createCharacter(t,e){return"bowman"===e?new i(t,"bowman"):"swordsman"===e?new r(t,"swordsman"):"magician"===e?new l(t,"magician"):"undead"===e?new h(t,"undead"):"vampire"===e?new o(t,"vampire"):"daemon"===e&&new n(t,"daemon")}load(){try{const a=this.stateService.load();this.gameState.player=a.player,this.gameState.level=a.level,this.gameState.selectedCell=a.selectedCell,this.gameState.selectedCharacter=a.selectedCharacter,this.gameState.selectedCell&&this.gamePlay.selectCell(this.gameState.selectedCell,"yellow"),this.gameState.selectedCharacter=a.selectedCharacter,this.startPosition=[],a.startPosition.forEach((t=>{const e=this.createCharacter(t.character.level,t.character.type);e.attack=t.character.attack,e.defence=t.character.defence,e.health=t.character.health;const a=new m(e,t.position);this.startPosition.push(a)})),this.gamePlay.drawUi(e[this.gameState.level]),this.gamePlay.redrawPositions(this.startPosition),t.showMessage("Игра загружена")}catch(e){t.showError("Нет сохранённой игры")}}characterInformation(t){return`🎖${t.level} ⚔${t.attack} 🛡${t.defence}  ❤${t.health}`}teamSize(t){let e=0;if(t===this.heroTeam)for(const t of this.startPosition)"bowman"!==t.character.type&&"swordsman"!==t.character.type&&"magician"!==t.character.type||(e+=1);if(t===this.computerTeam)for(const t of this.startPosition)"undead"!==t.character.type&&"vampire"!==t.character.type&&"daemon"!==t.character.type||(e+=1);return e}onCellClick(e){if(!0===this.gameState.player&&(this.selectedCharactar(this.startPosition,e),this.positionMove(this.selectCharacter,this.seceltedCell).indexOf(e)>=0&&(this.startPosition.map((t=>(t.position===this.seceltedCell&&(t.position=e,this.gamePlay.deselectCell(this.seceltedCell),this.seceltedCell=e,this.gamePlay.selectCell(e,"yellow")),t))),this.gamePlay.redrawPositions(this.startPosition),this.computerAttack()),this.positionAttack(this.selectCharacter,this.seceltedCell).indexOf(e)>=0)){const a=this.startPosition.find((t=>t.position===e));if(a){const s=Math.floor(Math.max(.2*(this.selectCharacter.attack-a.character.defence),.1*this.selectCharacter.attack));if(a.character.health-=s,a.character.health<1&&(this.startPosition=this.startPosition.filter((t=>t.position!==e))),this.gamePlay.redrawPositions(this.startPosition),0===this.teamSize(this.computerTeam))return 4===this.gameState.level?(this.gameState.player=!1,void t.showMessage("Вы выиграли")):(this.gameState.level+=1,this.levelUp(),this.seceltedCell=null,this.selectCharacter=[],void this.startLevel());this.gamePlay.showDamage(e,s).then((()=>{setTimeout((()=>{this.computerAttack()}),50)})),this.gameState.player=!1}}}onCellEnter(t){const e=this.positionAttack(this.selectCharacter,this.seceltedCell);for(let a=0;a<this.startPosition.length;a+=1){const s=this.startPosition[a];if(s.position===t){this.gamePlay.setCursor(p);const a=this.characterInformation(s.character);this.gamePlay.showCellTooltip(a,t),"undead"!==s.character.type&&"vampire"!==s.character.type&&"daemon"!==s.character.type||s.position!==t||(e.indexOf(t)>=0?(this.gamePlay.setCursor(u),this.gamePlay.selectCell(t,"red")):(this.gamePlay.setCursor(f),this.gamePlay.deselectCell(t)))}}this.positionMove(this.selectCharacter,this.seceltedCell).includes(t)&&null!==this.seceltedCell&&this.gamePlay.selectCell(t,"green")}onCellLeave(t){t===this.seceltedCell&&null!==this.seceltedCell||this.gamePlay.deselectCell(t)}}(y,g);C.init()}();